[tool:pytest]
# Pytest configuration for MHM testing framework

# Test discovery - only include tests directory (prevents scripts discovery)
testpaths = tests/
# Exclude scripts directory from test discovery
norecursedirs = scripts
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Markers for test categorization
# Streamlined to ~15-18 markers aligned with actual usage and component structure
markers =
    # Category markers (REQUIRED - every test must have one)
    unit: Unit tests for individual functions
    integration: Integration tests across modules
    behavior: Behavior tests for real system functionality
    ui: Tests for UI components
    
    # Speed markers (for filtering)
    slow: Slow-running tests (>1 second)
    fast: Fast-running tests (<100ms, optional)
    
    # Resource markers (for execution constraints)
    asyncio: Async tests requiring asyncio support
    no_parallel: Tests that must not run under pytest-xdist parallel execution
    
    # Feature markers (aligned with component loggers)
    tasks: Task management functionality tests (includes reminders)
    scheduler: Scheduler functionality tests
    checkins: Check-in system tests
    messages: Message system tests
    analytics: Analytics and reporting tests
    user_management: User account management tests
    communication: Tests for communication channels (Discord, email, etc.)
    ai: Tests requiring AI functionality
    
    # Quality markers (for test importance/type)
    critical: Critical path tests that must always pass
    regression: Tests that catch regression issues
    smoke: Basic functionality smoke tests

# Test execution options
addopts = 
    --strict-markers
    --tb=short
    --color=yes
    --durations=10
    --strict-config
    --strict-markers
    --verbose
    --tb=short
    --maxfail=10
    --durations=10
    --durations-min=0.1
    --ignore=scripts
    --disable-warnings

# Test environment
# Disable log rotation during tests to prevent file locking issues
env = 
    DISABLE_LOG_ROTATION=1

filterwarnings =
    # General deprecation warnings (many from external libraries)
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning
    # Suppress deprecation warnings from operations.py during transition period
    ignore:.*development_tools.shared.operations is deprecated.*:DeprecationWarning
    ignore::UserWarning
    ignore:Duplicate name:zipfile:UserWarning
    ignore::FutureWarning
    ignore:.*There is no current event loop.*:DeprecationWarning
    # Suppress __package__ != __spec__.parent warnings from relative imports in development_tools
    # These occur when modules are loaded directly rather than as part of a package
    # Match various formats of the warning message - use module path to be more specific
    ignore:__package__ != __spec__\.parent:DeprecationWarning:development_tools
    ignore:.*__package__ != __spec__\.parent.*:DeprecationWarning:development_tools
    ignore:.*__package__.*!=.*__spec__\.parent.*:DeprecationWarning:development_tools
    ignore:.*__package__.*!.*__spec__\.parent.*:DeprecationWarning:development_tools
    # Catch-all for any __package__ warnings from development_tools modules
    ignore:.*__package__.*:DeprecationWarning:development_tools.docs.analyze_documentation_sync
    ignore:.*__package__.*:DeprecationWarning:development_tools.imports.generate_module_dependencies
    ignore:.*__package__.*:DeprecationWarning:development_tools.legacy.fix_legacy_references
    ignore:.*__package__.*:DeprecationWarning:development_tools.functions.generate_function_registry
    ignore:.*__package__.*:DeprecationWarning:development_tools.reports.quick_status
    ignore:.*__package__.*:DeprecationWarning:development_tools.reports.system_signals
    
    # Resource warnings - mostly from external libraries or edge cases
    # Note: We use context managers for file operations and have cleanup methods for aiohttp sessions
    # These warnings are typically from discord.py's internal aiohttp usage or test mocks
    ignore:.*unclosed.*:ResourceWarning
    ignore:.*I/O operation on closed file.*:ValueError
    
    # Discord library warnings (external library, cannot be controlled)
    # These are from discord.py itself and will be resolved when the library updates
    ignore:audioop is deprecated:DeprecationWarning
    ignore:parameter 'timeout' of type 'float' is deprecated:DeprecationWarning
    
    # Thread exception warnings from our own tests (expected behavior in test environment)
    ignore::pytest.PytestUnhandledThreadExceptionWarning
    ignore::pytest.PytestUnraisableExceptionWarning
    
    # aiohttp session cleanup warnings
    # Note: We have cleanup methods in DiscordBot._cleanup_aiohttp_sessions()
    # These warnings are typically from discord.py's internal aiohttp usage or test mocks
    ignore:.*Unclosed client session.*:ResourceWarning
    ignore:.*Task was destroyed but it is pending.*:RuntimeWarning
    
    # Coroutine warnings from test mocks (expected in test environment)
    # AsyncMock objects create coroutines that may not be awaited in test scenarios
    # Also ignore coroutines from webhook handler that may not be scheduled in test environments
    ignore:.*coroutine.*was never awaited.*:RuntimeWarning
    ignore:.*coroutine 'handle_application_authorized.*_send_welcome_dm'.*was never awaited.*:RuntimeWarning
    ignore:.*coroutine 'AsyncMockMixin._execute_mock_call'.*was never awaited.*:RuntimeWarning
    
    
    # AI test collection warnings - these classes are run via run_ai_functionality_tests.py, not pytest
    ignore:.*cannot collect test class.*because it has a __init__ constructor.*:pytest.PytestCollectionWarning
    # Development tools implementation classes - these are not test classes despite starting with "Test"
    # These classes are implementation classes, not test classes, but pytest tries to collect them because they start with "Test"
    # Match the exact warning message format from pytest
    ignore:.*cannot collect test class 'TestCoverageAnalyzer'.*:pytest.PytestCollectionWarning
    ignore:.*cannot collect test class 'TestCoverageReportGenerator'.*:pytest.PytestCollectionWarning
    # Also match any PytestCollectionWarning from development_tools/tests modules (catch-all)
    ignore::pytest.PytestCollectionWarning:development_tools.tests

# Coverage settings (when using --cov)
# Note: Coverage options are added via command line when --coverage is used

# Test isolation
# Each test function gets a fresh environment
pythonpath = .

# Logging configuration
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(name)s: %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# Test collection
collect_ignore = 
    tests/__pycache__
    tests/.pytest_cache
    tests/logs/
    tests/data/
    tests/temp/
    tests/fixtures/
    scripts/
    scripts/*
    scripts/**/*
    **/__pycache__
    **/.pytest_cache
    **/*.pyc
    **/*.pyo
    # AI functionality test files - run via run_ai_functionality_tests.py, not pytest
    tests/ai/test_ai_core.py
    tests/ai/test_ai_integration.py
    tests/ai/test_ai_errors.py
    tests/ai/test_ai_cache.py
    tests/ai/test_ai_performance.py
    tests/ai/test_ai_quality.py
    tests/ai/test_ai_advanced.py
    # Development tools implementation files (not test files) - classes starting with "Test" are implementation classes, not test classes
    development_tools/tests/analyze_test_coverage.py
    development_tools/tests/generate_test_coverage_reports.py

# Minimum version requirements
minversion = 6.0

# Test timeout (for slow tests)
timeout = 300

# Parallel execution (if pytest-xdist is installed)
# addopts = -n auto

# Test result caching
cache_dir = .pytest_cache

# Configure pytest to use tests/data/tmp for temporary directories instead of creating pytest-of-* directories
# This ensures all temporary files stay within tests/data
# Note: This is configured in conftest.py's pytest_configure hook since pytest.ini doesn't support tmp_path_factory 